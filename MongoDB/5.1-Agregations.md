# 6. Agrégation

## 6.1 Framework d'agrégation

### Concept de pipeline

Le framework d'agrégation de MongoDB repose sur le principe de pipeline :
- Les documents passent à travers une série d'étapes séquentielles
- Chaque étape transforme les documents et les transmet à l'étape suivante
- Le résultat final est le produit de toutes ces transformations

**Syntaxe de base :**
```javascript
db.collection.aggregate([
    { étape1 },
    { étape2 },
    { étape3 }
])
```

### Différence avec les requêtes simples
- `find()` : filtrage et projection simples
- `aggregate()` : transformations complexes, calculs, regroupements, jointures

**Exemple comparatif :**
```javascript
// Avec find() - limité
db.ventes.find({ montant: { $gt: 100 } })

// Avec aggregate() - puissant
db.ventes.aggregate([
    { $match: { montant: { $gt: 100 } } },
    { $group: { _id: "$categorie", total: { $sum: "$montant" } } },
    { $sort: { total: -1 } }
])
```

## 6.2 Étapes principales

### $match : filtrage
Filtre les documents selon des critères (équivalent à `find()`).
```javascript
db.produits.aggregate([
    { $match: { prix: { $gte: 50 }, stock: { $gt: 0 } } }
])
```

**Points clés :**
- Placer `$match` au début du pipeline pour réduire le volume de données
- Utilise les mêmes opérateurs que `find()`
- Peut être utilisé plusieurs fois dans un pipeline

### $project : projection et transformation
Sélectionne, exclut ou transforme des champs.
```javascript
db.commandes.aggregate([
    {
        $project: {
            numero: 1,
            client: 1,
            totalHT: "$montant",
            totalTTC: { $multiply: ["$montant", 1.2] },
            _id: 0
        }
    }
])
```

**Opérations possibles :**
- Inclusion/exclusion de champs : `1` ou `0`
- Renommage : `nouveauNom: "$ancienNom"`
- Calculs : opérateurs arithmétiques
- Création de champs calculés
  **résultat :**
```js
[
  {
    numero: "ORD-2024-001",
    client: "Pierre Martin",
    totalHT: 1299.99,
    totalTTC: 1559.988
  },
  {
    numero: "ORD-2024-002",
    client: "Marie Dubois",
    totalHT: 899.99,
    totalTTC: 1079.988
  },
  {
    numero: "ORD-2024-003",
    client: "Sophie Durand",
    totalHT: 129.99,
    totalTTC: 155.988
  }
]
```

### $group : regroupement et calculs
Regroupe les documents selon un critère et effectue des calculs.
```javascript
db.ventes.aggregate([
  {
    $group: {
      _id: "$categorie",
      nombreVentes: { $count: {} },
      chiffreAffaires: { $sum: "$montant" },
      venteMoyenne: { $avg: "$montant" },
      venteMax: { $max: "$montant" },
      venteMin: { $min: "$montant" }
    }
  }
])
```

**Accumulateurs disponibles :**
- `$sum` : somme
- `$avg` : moyenne
- `$min` / `$max` : minimum / maximum
- `$count` : nombre de documents
- `$first` / `$last` : première / dernière valeur

**résultat :**
```js
[
  {
    _id: "Électronique",
    nombreVentes: 15,
    chiffreAffaires: 23450.50,
    venteMoyenne: 1563.37,
    venteMax: 2599.99,
    venteMin: 299.99
  },
  {
    _id: "Vêtements",
    nombreVentes: 28,
    chiffreAffaires: 3850.75,
    venteMoyenne: 137.53,
    venteMax: 249.99,
    venteMin: 29.99
  },
  {
    _id: "Alimentation",
    nombreVentes: 42,
    chiffreAffaires: 1680.20,
    venteMoyenne: 40.00,
    venteMax: 89.99,
    venteMin: 5.50
  }
]
```

**Regroupement multiple :**
```javascript
db.ventes.aggregate([
  {
    $group: {
      _id: { 
        annee: { $year: "$date" },
        mois: { $month: "$date" }
      },
      total: { $sum: "$montant" }
    }
  }
])
```
**résultat :**
```js
[
  {
    _id: { annee: 2024, mois: 1 },
    total: 5420.30
  },
  {
    _id: { annee: 2024, mois: 2 },
    total: 6180.75
  },
  {
    _id: { annee: 2024, mois: 3 },
    total: 7350.20
  },
  {
    _id: { annee: 2024, mois: 4 },
    total: 4890.50
  }
]
```

### $sort : tri
Trie les documents.
```javascript
db.produits.aggregate([
  { $sort: { prix: -1, nom: 1 } }  // -1 = décroissant, 1 = croissant
])
```

**Bonnes pratiques :**
- Trier avant `$limit` pour obtenir les "top N"
- Utiliser un index si possible pour améliorer les performances

### $limit et $skip : pagination
```javascript
// Afficher les 10 produits les plus chers
db.produits.aggregate([
  { $sort: { prix: -1 } },
  { $limit: 10 }
])

// Pagination : page 3, 20 résultats par page
db.produits.aggregate([
  { $sort: { nom: 1 } },
  { $skip: 40 },
  { $limit: 20 }
])
```

## 6.3 Opérateurs d'agrégation

### Opérateurs arithmétiques
```javascript
db.factures.aggregate([
  {
    $project: {
      numero: 1,
      montantHT: 1,
      TVA: { $multiply: ["$montantHT", 0.2] },
      montantTTC: { $multiply: ["$montantHT", 1.2] },
      remise: { $subtract: ["$montantInitial", "$montantHT"] },
      moyenneArticle: { $divide: ["$montantHT", "$nombreArticles"] }
    }
  }
])
```

**Opérateurs disponibles :**
- `$add` : addition
- `$subtract` : soustraction
- `$multiply` : multiplication
- `$divide` : division
- `$mod` : modulo

**résultat :**
```js
[
  {
    _id: ObjectId("650a11111111111111110001"),
    numero: "FAC-2024-001",
    montantHT: 500.00,
    TVA: 100.00,
    montantTTC: 600.00,
    remise: 50.00,
    moyenneArticle: 125.00
  },
  {
    _id: ObjectId("650a11111111111111110002"),
    numero: "FAC-2024-002",
    montantHT: 1200.00,
    TVA: 240.00,
    montantTTC: 1440.00,
    remise: 0.00,
    moyenneArticle: 400.00
  },
  {
    _id: ObjectId("650a11111111111111110003"),
    numero: "FAC-2024-003",
    montantHT: 350.00,
    TVA: 70.00,
    montantTTC: 420.00,
    remise: 25.00,
    moyenneArticle: 175.00
  }
]
```

### Opérateurs de tableaux
```javascript
db.commandes.aggregate([
  {
    $project: {
      numero: 1,
      nombreArticles: { $size: "$articles" },
      premierArticle: { $arrayElemAt: ["$articles", 0] },
      articlesUniques: { $setUnion: ["$articles", []] },
      sousEnsemble: { $slice: ["$articles", 2, 3] }  // depuis index 2, 3 éléments
    }
  }
])
```

**Opérateurs utiles :**
- `$size` : taille d'un tableau
- `$arrayElemAt` : élément à un index
- `$slice` : sous-ensemble
- `$concatArrays` : concaténation
- `$filter` : filtrage
- `$setUnion` : fusionne plusieurs tableaux en un seul en éliminant les doublons

**résultat :**
```js
[
  {
    _id: ObjectId("650a44444444444444440001"),
    numero: "CMD-001",
    nombreArticles: 5,
    premierArticle: "Laptop",
    articlesUniques: ["Laptop", "Souris", "Clavier", "Écran", "Webcam"],
    sousEnsemble: ["Clavier", "Écran", "Webcam"]
  },
  {
    _id: ObjectId("650a44444444444444440002"),
    numero: "CMD-002",
    nombreArticles: 3,
    premierArticle: "Smartphone",
    articlesUniques: ["Smartphone", "Coque", "Chargeur"],
    sousEnsemble: ["Chargeur"]
  },
  {
    _id: ObjectId("650a44444444444444440003"),
    numero: "CMD-003",
    nombreArticles: 2,
    premierArticle: "T-shirt",
    articlesUniques: ["T-shirt", "Pantalon"],
    sousEnsemble: []
  }
]
```

### Opérateurs de dates
```javascript
db.ventes.aggregate([
  {
    $project: {
      montant: 1,
      annee: { $year: "$date" },
      mois: { $month: "$date" },
      jour: { $dayOfMonth: "$date" },
      jourSemaine: { $dayOfWeek: "$date" },
      trimestre: { $ceil: { $divide: [{ $month: "$date" }, 3] } }
    }
  }
])
```

**Extraction :**
- `$year`, `$month`, `$dayOfMonth`
- `$hour`, `$minute`, `$second`
- `$dayOfWeek` : 1 (dimanche) à 7 (samedi)
- `$week` : numéro de semaine
- `$ceil` : arrondit un nombre à l'entier supérieur

## 6.4 Agrégations avancées

### $lookup : jointures entre collections

Permet de joindre des documents de collections différentes (équivalent JOIN SQL).

**Exemple avec commandes et clients :**
```javascript
db.commandes.aggregate([
  {
    $lookup: {
      from: "clients",
      localField: "clientId",
      foreignField: "_id",
      as: "infoClient"
    }
  }
])
```

**Résultat :**
```javascript
{
  _id: 1,
  clientId: 101,
  montant: 250,
  infoClient: [
    {
      _id: 101,
      nom: "Dupont",
      email: "dupont@mail.com"
    }
  ]
}
```

**Lookup avec pipeline (plus flexible) :**
```javascript
db.commandes.aggregate([
  {
    $lookup: {
      from: "clients",
      let: { client_id: "$clientId" },
      pipeline: [
        { $match: { $expr: { $eq: ["$_id", "$$client_id"] } } },
        { $project: { nom: 1, email: 1, _id: 0 } }
      ],
      as: "client"
    }
  }
])
```

### $unwind : décomposition de tableaux

Crée un document par élément de tableau.

**Avant $unwind :**
```javascript
{
  _id: 1,
  commande: "CMD001",
  articles: ["Laptop", "Souris", "Clavier"]
}
```

**Après $unwind :**
```javascript
db.commandes.aggregate([
  { $unwind: "$articles" }
])

// Résultat : 3 documents
{ _id: 1, commande: "CMD001", articles: "Laptop" }
{ _id: 1, commande: "CMD001", articles: "Souris" }
{ _id: 1, commande: "CMD001", articles: "Clavier" }
```

**Cas d'usage : analyse détaillée des articles vendus**
```javascript
db.commandes.aggregate([
  { $unwind: "$articles" },
  {
    $group: {
      _id: "$articles.produit",
      quantiteTotale: { $sum: "$articles.quantite" }
    }
  }
])
```
### $facet : agrégations parallèles
Permet d'exécuter plusieurs pipelines en parallèle sur les mêmes données.
```javascript
db.ventes.aggregate([
  {
    $facet: {
      parCategorie: [
        { $group: { _id: "$categorie", total: { $sum: "$montant" } } },
        { $sort: { total: -1 } }
      ],
      parVendeur: [
        { $group: { _id: "$vendeur", total: { $sum: "$montant" } } },
        { $sort: { total: -1 } },
        { $limit: 5 }
      ],
      statistiques: [
        {
          $group: {
            _id: null,
            totalGeneral: { $sum: "$montant" },
            moyenne: { $avg: "$montant" },
            nbVentes: { $count: {} }
          }
        }
      ]
    }
  }
])
```

**Resultat :**
```js
[
  {
    parCategorie: [
      { _id: "Électronique", total: 23450.50 },
      { _id: "Vêtements", total: 3850.75 },
      { _id: "Alimentation", total: 1680.20 }
    ],
    parVendeur: [
      { _id: "Alice", total: 12500.30 },
      { _id: "Bob", total: 9870.45 },
      { _id: "Claire", total: 4250.70 },
      { _id: "David", total: 2360.00 },
      { _id: "Emma", total: 1500.00 }
    ],
    statistiques: [
      {
        _id: null,
        totalGeneral: 28981.45,
        moyenne: 341.66,
        nbVentes: 85
      }
    ]
  }
]
```
## 7 Documentations : liste des opérateurs d'agrégation

```js
https://www.mongodb.com/docs/v5.0/reference/operator/aggregation/
```