
```js
// ============================================
// EXERCICE 1 : INSERTION DE DONNÉES
// ============================================

// --- 1.1 : Ajouter un nouveau client ---

db.customers.insertOne({
  firstName: "Claire",
  lastName: "Rousseau",
  email: "claire.rousseau@example.com",
  phone: "+33667890123",
  password: "$2b$10$newpasswordhashexample",
  addresses: [
    {
      type: "billing",
      isDefault: true,
      street: "33 rue Sainte-Catherine",
      city: "Bordeaux",
      postalCode: "33000",
      country: "France"
    },
    {
      type: "shipping",
      isDefault: true,
      street: "33 rue Sainte-Catherine",
      city: "Bordeaux",
      postalCode: "33000",
      country: "France"
    }
  ],
  preferences: {
    newsletter: true,
    language: "fr",
    currency: "EUR"
  },
  stats: {
    totalOrders: 0,
    totalSpent: 0,
    averageOrderValue: 0
  },
  createdAt: new Date(),
  lastLogin: new Date()
});
```

```js
// --- 1.2 : Ajouter plusieurs produits ---

db.products.insertMany([
  {
    name: "Souris sans fil",
    slug: "souris-sans-fil",
    description: "Souris ergonomique sans fil avec connexion Bluetooth",
    category: ObjectId("650a11111111111111110002"), // Informatique
    price: 39.99,
    currency: "EUR",
    stock: 150,
    sku: "MOUSE-WIRELESS-001",
    images: ["https://example.com/images/mouse-wireless.jpg"],
    specifications: {
      brand: "Logitech",
      connectivity: "Bluetooth",
      battery: "2 piles AA",
      dpi: "1000-4000"
    },
    tags: ["souris", "informatique", "sans-fil", "bluetooth"],
    reviews: [],
    rating: {
      average: 0,
      count: 0
    },
    isActive: true,
    createdAt: new Date(),
    updatedAt: new Date()
  },
  {
    name: "Écran 27 pouces",
    slug: "ecran-27-pouces",
    description: "Écran LED 27 pouces Full HD avec technologie IPS",
    category: ObjectId("650a11111111111111110002"), // Informatique
    price: 349.99,
    currency: "EUR",
    stock: 30,
    sku: "SCREEN-27-001",
    images: ["https://example.com/images/screen-27.jpg"],
    specifications: {
      brand: "Dell",
      size: "27 pouces",
      resolution: "1920x1080",
      panel: "IPS",
      refreshRate: "75Hz"
    },
    tags: ["écran", "informatique", "monitor", "full-hd"],
    reviews: [],
    rating: {
      average: 0,
      count: 0
    },
    isActive: true,
    createdAt: new Date(),
    updatedAt: new Date()
  },
  {
    name: "Webcam HD",
    slug: "webcam-hd",
    description: "Webcam Full HD 1080p avec microphone intégré",
    category: ObjectId("650a11111111111111110002"), // Informatique
    price: 79.99,
    currency: "EUR",
    stock: 80,
    sku: "WEBCAM-HD-001",
    images: ["https://example.com/images/webcam-hd.jpg"],
    specifications: {
      brand: "Logitech",
      resolution: "1080p",
      fps: "30",
      microphone: "Stéréo intégré",
      connectivity: "USB-A"
    },
    tags: ["webcam", "informatique", "vidéo", "visioconférence"],
    reviews: [],
    rating: {
      average: 0,
      count: 0
    },
    isActive: true,
    createdAt: new Date(),
    updatedAt: new Date()
  }
]);
```

```js
// --- 1.3 : Ajouter une nouvelle catégorie ---

db.categories.insertOne({
  name: "Accessoires",
  slug: "accessoires",
  description: "Accessoires électroniques et informatiques",
  parent: ObjectId("650a11111111111111110001"), // Électronique
  createdAt: new Date()
});

```

```js
// ============================================
// EXERCICE 2 : LECTURE DE DONNÉES
// ============================================

// --- 2.1 : Requêtes simples ---

// 1. Afficher tous les produits de la catégorie Informatique
db.products.find({ 
  category: ObjectId("650a11111111111111110002") 
});

// 2. Afficher le client avec l'email "pierre.martin@example.com"
db.customers.findOne({ 
  email: "pierre.martin@example.com" 
});

// 3. Afficher toutes les commandes avec le statut "delivered"
db.orders.find({ 
  status: "delivered" 
});

// 4. Afficher les produits dont le prix est supérieur à 500 EUR
db.products.find({ 
  price: { $gt: 500 } 
});
```

```js
// --- 2.2 : Projections ---

// 1. Afficher uniquement le nom et le prix de tous les produits
db.products.find(
  {},
  { name: 1, price: 1 }
);

// 2. Afficher les clients avec uniquement firstName, lastName et email (sans _id)
db.customers.find(
  {},
  { _id: 0, firstName: 1, lastName: 1, email: 1 }
);

// 3. Afficher les commandes avec orderNumber, status et total
db.orders.find(
  {},
  { orderNumber: 1, status: 1, "pricing.total": 1 }
);

// --- 2.3 : Requêtes avec tri et limite ---

// 1. Afficher les 3 produits les plus chers
db.products.find()
  .sort({ price: -1 })
  .limit(3);

// 2. Afficher les 5 dernières commandes
db.orders.find()
  .sort({ orderDate: -1 })
  .limit(5);

// 3. Afficher les clients triés par ordre alphabétique
db.customers.find()
  .sort({ lastName: 1 });

```

```js
// ============================================
// EXERCICE 3 : MISE À JOUR DE DONNÉES
// ============================================

// --- 3.1 : Utilisation de $set ---

// 1. Modifier le prix du produit "Clavier mécanique RGB"
db.products.updateOne(
  { name: "Clavier mécanique RGB" },
  { $set: { price: 119.99 } }
);

// 2. Changer le statut de la commande "ORD-2024-007"
db.orders.updateOne(
  { orderNumber: "ORD-2024-007" },
  { $set: { status: "shipped" } }
);

// 3. Mettre à jour le stock du "Smartphone Galaxy S24"
db.products.updateOne(
  { name: "Smartphone Galaxy S24" },
  { $set: { stock: 150 } }
);

// --- 3.2 : Utilisation de $inc ---

// 1. Augmenter le stock de tous les produits de catégorie Vêtements
db.products.updateMany(
  { category: ObjectId("650a11111111111111110004") },
  { $inc: { stock: 50 } }
);

// 2. Incrémenter le nombre total de commandes de Pierre Martin
db.customers.updateOne(
  { _id: ObjectId("650a33333333333333330001") },
  { $inc: { "stats.totalOrders": 1 } }
);

// 3. Décrémenter le stock du produit avec le SKU "LAPTOP-XPS15-001"
db.products.updateOne(
  { sku: "LAPTOP-XPS15-001" },
  { $inc: { stock: -2 } }
);

// --- 3.3 : Utilisation de $push ---

// 1. Ajouter un nouvel avis au produit "Clavier mécanique RGB"
db.products.updateOne(
  { _id: ObjectId("650a22222222222222220003") },
  { 
    $push: { 
      reviews: {
        customer_id: ObjectId("650a33333333333333330002"),
        rating: 4,
        comment: "Bon clavier, frappes agréables",
        date: new Date(),
        verified_purchase: true
      }
    }
  }
);

// 2. Ajouter un tag "promo" au produit "T-shirt coton bio"
db.products.updateOne(
  { _id: ObjectId("650a22222222222222220004") },
  { $push: { tags: "promo" } }
);

// 3. Ajouter une nouvelle adresse de livraison pour Marie Dubois
db.customers.updateOne(
  { _id: ObjectId("650a33333333333333330002") },
  {
    $push: {
      addresses: {
        type: "shipping",
        isDefault: false,
        street: "12 promenade des Anglais",
        city: "Nice",
        postalCode: "06000",
        country: "France"
      }
    }
  }
);

// --- 3.4 : Utilisation de $pull ---

// 1. Retirer le tag "gaming" du produit "Clavier mécanique RGB"
db.products.updateOne(
  { _id: ObjectId("650a22222222222222220003") },
  { $pull: { tags: "gaming" } }
);

// 2. Supprimer l'adresse de livraison de Marseille pour Marie Dubois
db.customers.updateOne(
  { _id: ObjectId("650a33333333333333330002") },
  {
    $pull: {
      addresses: {
        city: "Marseille",
        postalCode: "13001"
      }
    }
  }
);

// --- 3.5 : Mise à jour multiple ---

// 1. Désactiver tous les produits dont le stock est égal à 0
db.products.updateMany(
  { stock: 0 },
  { $set: { isActive: false } }
);

// 2. Appliquer une remise de 10% sur tous les produits de la catégorie Vêtements
db.products.updateMany(
  { category: ObjectId("650a11111111111111110004") },
  { $mul: { price: 0.9 } }
);

// Alternative avec calcul explicite :
db.products.find({ category: ObjectId("650a11111111111111110004") }).forEach(function(product) {
  db.products.updateOne(
    { _id: product._id },
    { $set: { price: product.price * 0.9 } }
  );
});

// 3. Ajouter un champ "urgent" à true pour toutes les commandes "pending"
db.orders.updateMany(
  { status: "pending" },
  { $set: { urgent: true } }
);

// --- 3.6 : Upsert ---

// 1. Mettre à jour ou créer un produit avec le SKU "MOUSE-WIRELESS-001"
db.products.updateOne(
  { sku: "MOUSE-WIRELESS-001" },
  {
    $set: {
      name: "Souris sans fil",
      price: 39.99,
      stock: 150,
      category: ObjectId("650a11111111111111110002")
    }
  },
  { upsert: true }
);

// 2. Mettre à jour le téléphone d'un client ou créer le client
db.customers.updateOne(
  { email: "nouveau@example.com" },
  {
    $set: {
      firstName: "Nouveau",
      lastName: "Client",
      phone: "+33600000000",
      createdAt: new Date()
    }
  },
  { upsert: true }
);

```

```js
// ============================================
// EXERCICE 4 : SUPPRESSION DE DONNÉES
// ============================================

// --- 4.1 : Suppressions simples ---

// 1. Supprimer le produit avec le SKU "KEYB-MECH-RGB-001"
// ATTENTION : Toujours tester avant avec find()
db.products.find({ sku: "KEYB-MECH-RGB-001" });
// Puis supprimer
db.products.deleteOne({ sku: "KEYB-MECH-RGB-001" });

// 2. Supprimer un client de test
db.customers.deleteOne({ email: "test@example.com" });

// 3. Supprimer la commande "ORD-2024-001"
db.orders.deleteOne({ orderNumber: "ORD-2024-001" });

// --- 4.2 : Suppressions multiples ---

// 1. Supprimer tous les avis avec un rating inférieur à 3
db.products.updateMany(
  {},
  {
    $pull: {
      reviews: { rating: { $lt: 3 } }
    }
  }
);

// 2. Supprimer toutes les commandes avec le statut "cancelled"
db.orders.deleteMany({ status: "cancelled" });

// 3. Supprimer tous les produits inactifs
db.products.deleteMany({ isActive: false });

// --- 4.3 : Soft delete ---

// 1. Soft delete d'un produit
db.products.updateOne(
  { _id: ObjectId("650a22222222222222220004") },
  {
    $set: {
      deleted: true,
      deletedAt: new Date()
    }
  }
);

// 2. Archiver le client Lucas Bernard
db.customers.updateOne(
  { _id: ObjectId("650a33333333333333330003") },
  {
    $set: {
      deleted: true,
      deletedAt: new Date()
    }
  }
);

// Requête pour exclure les éléments supprimés
db.products.find({ deleted: { $ne: true } });
db.customers.find({ deleted: { $ne: true } });

```

```js
// ============================================
// EXERCICE 5 : OPÉRATIONS COMBINÉES
// ============================================

// --- 5.1 : Scénario - Traitement d'une commande ---

// 1. Créer la commande
db.orders.insertOne({
  orderNumber: "ORD-2024-009",
  customer_id: ObjectId("650a33333333333333330005"),
  orderDate: new Date(),
  status: "pending",
  items: [
    {
      product_id: ObjectId("650a22222222222222220003"),
      name: "Clavier mécanique RGB",
      sku: "KEYB-MECH-RGB-001",
      quantity: 1,
      unitPrice: 119.99,
      totalPrice: 119.99
    }
  ],
  shippingAddress: {
    firstName: "Thomas",
    lastName: "Robert",
    street: "31 rue Nationale",
    city: "Lille",
    postalCode: "59000",
    country: "France",
    phone: "+33656789012"
  },
  billingAddress: {
    firstName: "Thomas",
    lastName: "Robert",
    street: "31 rue Nationale",
    city: "Lille",
    postalCode: "59000",
    country: "France"
  },
  payment: {
    method: "credit_card",
    status: "paid",
    transactionId: "TRX-20241025-007",
    paidAt: new Date()
  },
  pricing: {
    subtotal: 119.99,
    shipping: 4.99,
    tax: 24.00,
    discount: 0.00,
    total: 148.98
  },
  timeline: [
    {
      status: "pending",
      date: new Date(),
      note: "Commande créée"
    }
  ],
  createdAt: new Date(),
  updatedAt: new Date()
});

// 2. Décrémenter le stock du produit
db.products.updateOne(
  { _id: ObjectId("650a22222222222222220003") },
  { $inc: { stock: -1 } }
);

// 3. Mettre à jour les statistiques du client
db.customers.updateOne(
  { _id: ObjectId("650a33333333333333330005") },
  {
    $inc: {
      "stats.totalOrders": 1,
      "stats.totalSpent": 148.98
    }
  }
);

// 4. Recalculer la moyenne
const customer = db.customers.findOne({ _id: ObjectId("650a33333333333333330005") });
const newAverage = customer.stats.totalSpent / customer.stats.totalOrders;

db.customers.updateOne(
  { _id: ObjectId("650a33333333333333330005") },
  {
    $set: { "stats.averageOrderValue": newAverage }
  }
);

// 5. Changer le statut de la commande
db.orders.updateOne(
  { orderNumber: "ORD-2024-009" },
  {
    $set: { status: "processing" },
    $push: {
      timeline: {
        status: "processing",
        date: new Date(),
        note: "Paiement confirmé, en préparation"
      }
    }
  }
);

// --- 5.2 : Scénario - Retour produit ---

// 1. Changer le statut de la commande en "returned"
db.orders.updateOne(
  { orderNumber: "ORD-2024-004" },
  {
    $set: { status: "returned" },
    $push: {
      timeline: {
        status: "returned",
        date: new Date(),
        note: "Produit retourné par le client"
      }
    }
  }
);

// 2. Réincrémenter le stock
db.products.updateOne(
  { _id: ObjectId("650a22222222222222220002") },
  { $inc: { stock: 1 } }
);

// 3. Mettre à jour les statistiques du client
const order = db.orders.findOne({ orderNumber: "ORD-2024-004" });

db.customers.updateOne(
  { _id: ObjectId("650a33333333333333330003") },
  {
    $inc: {
      "stats.totalOrders": -1,
      "stats.totalSpent": -order.pricing.total
    }
  }
);

// --- 5.3 : Scénario - Gestion des avis ---

// 1. Ajouter l'avis
db.products.updateOne(
  { _id: ObjectId("650a22222222222222220003") },
  {
    $push: {
      reviews: {
        customer_id: ObjectId("650a33333333333333330005"),
        rating: 5,
        comment: "Excellent pour le gaming",
        date: new Date(),
        verified_purchase: true
      }
    }
  }
);

// 2 & 3. Recalculer la moyenne et le nombre d'avis
const product = db.products.findOne({ _id: ObjectId("650a22222222222222220003") });
const totalRating = product.reviews.reduce((sum, review) => sum + review.rating, 0);
const averageRating = totalRating / product.reviews.length;

db.products.updateOne(
  { _id: ObjectId("650a22222222222222220003") },
  {
    $set: {
      "rating.average": averageRating,
      "rating.count": product.reviews.length,
      updatedAt: new Date()
    }
  }
);

```

```js
// ============================================
// EXERCICE 6 : REQUÊTES AVANCÉES DE LECTURE
// ============================================

// --- 6.1 : Recherche dans les sous-documents ---

// 1. Trouver tous les clients ayant une adresse à Paris
db.customers.find({
  "addresses.city": "Paris"
});

// 2. Trouver tous les produits avec "Samsung" dans specifications.brand
db.products.find({
  "specifications.brand": "Samsung"
});

// 3. Trouver toutes les commandes contenant le produit "Ordinateur portable XPS 15"
db.orders.find({
  "items.product_id": ObjectId("650a22222222222222220001")
});

// --- 6.2 : Recherche dans les tableaux ---

// 1. Trouver tous les produits avec le tag "bio"
db.products.find({
  tags: "bio"
});

// 2. Trouver tous les clients abonnés à la newsletter
db.customers.find({
  "preferences.newsletter": true
});

// 3. Trouver tous les produits ayant au moins un avis avec rating = 5
db.products.find({
  "reviews.rating": 5
});

// Avec $elemMatch pour plus de précision
db.products.find({
  reviews: {
    $elemMatch: { rating: 5 }
  }
});

// --- 6.3 : Comptages et agrégations simples ---

// 1. Compter le nombre total de produits par catégorie
db.products.aggregate([
  {
    $group: {
      _id: "$category",
      count: { $sum: 1 }
    }
  },
  {
    $lookup: {
      from: "categories",
      localField: "_id",
      foreignField: "_id",
      as: "categoryInfo"
    }
  },
  {
    $project: {
      _id: 1,
      count: 1,
      categoryName: { $arrayElemAt: ["$categoryInfo.name", 0] }
    }
  }
]);

// 2. Calculer le montant total de toutes les commandes "delivered"
db.orders.aggregate([
  {
    $match: { status: "delivered" }
  },
  {
    $group: {
      _id: null,
      totalAmount: { $sum: "$pricing.total" }
    }
  }
]);

// 3. Compter le nombre de commandes par statut
db.orders.aggregate([
  {
    $group: {
      _id: "$status",
      count: { $sum: 1 }
    }
  },
  {
    $sort: { count: -1 }
  }
]);

```

```js
// ============================================
// EXERCICE 7 : CAS PRATIQUE COMPLET
// Mission : Promotion "Black Friday"
// ============================================

// --- 1. Créer la collection promotions ---

db.promotions.insertOne({
  code: "BLACKFRIDAY",
  pourcentage: 20,
  dateDebut: new Date("2024-11-29"),
  dateFin: new Date("2024-12-01"),
  montantMinimum: 100,
  categories: [
    ObjectId("650a11111111111111110001"), // Électronique
    ObjectId("650a11111111111111110002")  // Informatique
  ],
  utilisations: 0,
  montantTotalReductions: 0,
  createdAt: new Date(),
  isActive: true
});

// --- 2. Appliquer la promotion sur les produits ---

// Ajouter le code promo aux produits concernés
db.products.updateMany(
  {
    category: {
      $in: [
        ObjectId("650a11111111111111110001"),
        ObjectId("650a11111111111111110002")
      ]
    }
  },
  {
    $set: {
      promotionCode: "BLACKFRIDAY",
      promotionActive: true
    }
  }
);

// Calculer et stocker le prix promotionnel
db.products.find({
  promotionCode: "BLACKFRIDAY"
}).forEach(function(product) {
  const discountedPrice = product.price * 0.8; // 20% de réduction
  db.products.updateOne(
    { _id: product._id },
    {
      $set: {
        originalPrice: product.price,
        promotionalPrice: discountedPrice
      }
    }
  );
});

// --- 3. Créer une commande utilisant la promotion ---

// D'abord, récupérer un produit en promotion
const promoProduct = db.products.findOne({
  promotionCode: "BLACKFRIDAY",
  promotionalPrice: { $exists: true }
});

// Calculer la réduction
const subtotal = promoProduct.promotionalPrice * 2; // 2 produits
const discount = (promoProduct.originalPrice * 2) - subtotal;

// Créer la commande
db.orders.insertOne({
  orderNumber: "ORD-2024-010",
  customer_id: ObjectId("650a33333333333333330001"),
  orderDate: new Date(),
  status: "pending",
  items: [
    {
      product_id: promoProduct._id,
      name: promoProduct.name,
      sku: promoProduct.sku,
      quantity: 2,
      unitPrice: promoProduct.promotionalPrice,
      originalPrice: promoProduct.originalPrice,
      totalPrice: subtotal
    }
  ],
  shippingAddress: {
    firstName: "Pierre",
    lastName: "Martin",
    street: "15 rue de la République",
    city: "Lyon",
    postalCode: "69002",
    country: "France",
    phone: "+33612345678"
  },
  billingAddress: {
    firstName: "Pierre",
    lastName: "Martin",
    street: "15 rue de la République",
    city: "Lyon",
    postalCode: "69002",
    country: "France"
  },
  payment: {
    method: "credit_card",
    status: "paid",
    transactionId: "TRX-20241129-BF001",
    paidAt: new Date()
  },
  pricing: {
    subtotal: subtotal,
    shipping: 0.00,
    tax: subtotal * 0.2,
    discount: discount,
    total: subtotal + (subtotal * 0.2)
  },
  couponCode: "BLACKFRIDAY",
  timeline: [
    {
      status: "pending",
      date: new Date(),
      note: "Commande créée avec promotion Black Friday"
    }
  ],
  createdAt: new Date(),
  updatedAt: new Date()
});

// Mettre à jour les statistiques de la promotion
db.promotions.updateOne(
  { code: "BLACKFRIDAY" },
  {
    $inc: {
      utilisations: 1,
      montantTotalReductions: discount
    }
  }
);

// --- 4. Statistiques promotions ---

// Compter combien de produits sont en promotion
db.products.countDocuments({
  promotionCode: "BLACKFRIDAY",
  promotionActive: true
});

// Calculer le montant total des réductions
db.promotions.findOne(
  { code: "BLACKFRIDAY" },
  { montantTotalReductions: 1, utilisations: 1 }
);

// Statistiques détaillées par catégorie
db.products.aggregate([
  {
    $match: {
      promotionCode: "BLACKFRIDAY",
      promotionActive: true
    }
  },
  {
    $group: {
      _id: "$category",
      produitsEnPromo: { $sum: 1 },
      reductionMoyenne: {
        $avg: { $subtract: ["$originalPrice", "$promotionalPrice"] }
      }
    }
  },
  {
    $lookup: {
      from: "categories",
      localField: "_id",
      foreignField: "_id",
      as: "categoryInfo"
    }
  },
  {
    $project: {
      categoryName: { $arrayElemAt: ["$categoryInfo.name", 0] },
      produitsEnPromo: 1,
      reductionMoyenne: { $round: ["$reductionMoyenne", 2] }
    }
  }
]);

// Trouver les commandes qui ont utilisé le code promo
db.orders.find({
  couponCode: "BLACKFRIDAY"
});

// Calculer le montant total économisé par tous les clients
db.orders.aggregate([
  {
    $match: { couponCode: "BLACKFRIDAY" }
  },
  {
    $group: {
      _id: null,
      totalReductions: { $sum: "$pricing.discount" },
      nombreCommandes: { $sum: 1 }
    }
  }
]);
```
