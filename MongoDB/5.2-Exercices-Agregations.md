# Exercices : Agrégation

## Exercice 1 : Statistiques simples

### 1.1 Chiffre d'affaires total

Calculer le chiffre d'affaires total réalisé (somme du champ `pricing.total` de toutes les commandes).

**Résultat attendu** : Un document avec le chiffre d'affaires total.

---

### 1.2 Nombre de commandes par statut

Compter le nombre de commandes pour chaque statut (`pending`, `processing`, `shipped`, `delivered`, `cancelled`, `returned`).

**Résultat attendu** : Liste des statuts avec leur nombre de commandes, triée par nombre décroissant.

---

### 1.3 Panier moyen

Calculer le montant moyen d'une commande (moyenne du champ `pricing.total`).

**Résultat attendu** : Un document avec la valeur du panier moyen.

---

## Exercice 2 : Agrégation avec filtrage

### 2.1 Ventes du mois d'octobre 2024

Calculer le chiffre d'affaires et le nombre de commandes pour le mois d'octobre 2024.

**Résultat attendu** : Un document avec le CA et le nombre de commandes.

---

### 2.2 Commandes livrées uniquement

Calculer le chiffre d'affaires total et le panier moyen uniquement pour les commandes avec le statut `delivered`.

**Résultat attendu** : Un document avec CA total et panier moyen des commandes livrées.

---

### 2.3 Commandes supérieures à 500 EUR

Compter le nombre de commandes dont le montant total dépasse 500 EUR.

**Résultat attendu** : Un document avec le nombre de commandes.

---

## Exercice 3 : Regroupements avancés

### 3.1 Chiffre d'affaires par mois

Calculer le chiffre d'affaires mensuel pour l'année 2024, regroupé par mois.

**Résultat attendu** : Liste avec année, mois, CA et nombre de commandes, triée par mois.

---

### 3.2 Chiffre d'affaires par ville

Calculer le chiffre d'affaires total par ville de livraison.

**Résultat attendu** : Liste des villes avec leur CA, triée par CA décroissant.

---

### 3.3 Analyse des méthodes de paiement

Pour chaque méthode de paiement (`credit_card`, `paypal`, `bank_transfer`), calculer :
- Le nombre de commandes
- Le chiffre d'affaires total
- Le montant moyen par commande

**Résultat attendu** : Liste des méthodes avec leurs statistiques, triée par CA décroissant.

---

## Exercice 4 : Analyse des produits

### 4.1 Produits les plus vendus

Calculer la quantité totale vendue pour chaque produit et afficher le top 5.

**Indices** :
- Utiliser `$unwind` sur le tableau `items`
- Regrouper par `items.product_id`

**Résultat attendu** : Top 5 des produits avec leur nom et quantité totale vendue.

---

### 4.2 Chiffre d'affaires par produit

Calculer le chiffre d'affaires généré par chaque produit (somme de `items.totalPrice`).

**Résultat attendu** : Liste des produits avec leur nom et CA, triée par CA décroissant.

---

### 4.3 Analyse du stock

Pour chaque produit actif (`isActive: true`), afficher :
- Le nom du produit
- Le stock actuel
- Le nombre total d'unités vendues
- Un indicateur de rotation : `vendu / stock`

**Résultat attendu** : Liste des produits avec leurs métriques de stock, triée par rotation décroissante.

---

## Exercice 5 : Jointures avec $lookup

### 5.1 Commandes avec informations client

Enrichir les commandes avec les informations complètes du client (nom, prénom, email).

**Résultat attendu** : Commandes avec un champ `clientInfo` contenant les données du client.

---

### 5.2 Produits avec leur catégorie

Afficher tous les produits actifs avec le nom de leur catégorie.

**Résultat attendu** : Liste des produits avec le champ `categoryName` ajouté.

---

### 5.3 Analyse complète des commandes

Pour chaque commande livrée (`delivered`), afficher :
- Le numéro de commande
- Le nom complet du client
- La liste des produits avec leur nom (pas juste l'ID)
- Le montant total

**Résultat attendu** : Vue complète des commandes livrées avec toutes les informations enrichies.

---

## Exercice 6 : Agrégations complexes

### 6.1 Clients les plus fidèles

Identifier les 3 clients ayant :
- Dépensé le plus d'argent au total
- Passé le plus de commandes

Afficher leur nom, email, nombre de commandes et montant total dépensé.

**Résultat attendu** : Top 3 des meilleurs clients avec leurs statistiques.

---

### 6.2 Performance mensuelle détaillée

Pour chaque mois de 2024, calculer :
- Le nombre de commandes
- Le chiffre d'affaires total
- Le panier moyen
- Le nombre de clients uniques
- Le nombre moyen d'articles par commande

**Résultat attendu** : Tableau de bord mensuel avec toutes ces métriques.

---

### 6.3 Analyse des frais de livraison

Calculer :
- Le montant total des frais de livraison encaissés
- Le montant moyen des frais de livraison
- Les frais de livraison par transporteur (`shipping.carrier`)

**Résultat attendu** : Statistiques globales et par transporteur.

---

## Exercice 7 : Projections et transformations

### 7.1 Restructuration des commandes

Créer une vue simplifiée des commandes avec :
- `numero` : le numéro de commande
- `client` : nom complet (prénom + nom depuis shippingAddress)
- `date` : date de commande
- `montant` : montant total
- `statut` : statut actuel
- `articles` : nombre d'articles dans la commande

**Résultat attendu** : Liste des commandes sous format simplifié.

---

### 7.2 Calcul de marges théoriques

Pour chaque produit vendu, calculer une marge théorique de 30% sur le prix unitaire.

Afficher :
- Le nom du produit
- Le prix de vente
- Le prix d'achat estimé (70% du prix de vente)
- La marge unitaire (30% du prix de vente)
- La marge totale (marge unitaire × quantité vendue)

**Résultat attendu** : Analyse de rentabilité par produit.

---

## Exercice 8 : Pipeline multi-étapes

### 8.1 Rapport de performance complet

Créer un rapport combinant plusieurs analyses avec `$facet` :

**Facette 1** : `ventesParStatut`
- Nombre et CA par statut de commande

**Facette 2** : `topProduits`
- Top 5 des produits les plus vendus (en quantité)

**Facette 3** : `topClients`
- Top 3 des clients ayant le plus dépensé

**Facette 4** : `statistiquesGlobales`
- CA total
- Nombre total de commandes
- Panier moyen
- Nombre de clients actifs

**Résultat attendu** : Un document avec les 4 facettes contenant toutes ces analyses.

---

### 8.2 Analyse de la satisfaction client

Calculer pour chaque produit ayant des avis (`reviews`) :
- Le nombre d'avis
- La note moyenne
- La répartition des notes (nombre d'avis par note de 1 à 5)
- Le pourcentage d'achats vérifiés

**Résultat attendu** : Analyse détaillée de la satisfaction par produit.

---

### 8.3 Segmentation des clients

Créer une segmentation des clients selon leur comportement d'achat :

- **VIP** : > 1000 EUR dépensés
- **Régulier** : entre 500 et 1000 EUR
- **Occasionnel** : entre 100 et 500 EUR
- **Nouveau** : < 100 EUR

Pour chaque segment, afficher :
- Le nombre de clients
- Le CA total généré
- Le panier moyen

**Résultat attendu** : Statistiques par segment de clientèle.