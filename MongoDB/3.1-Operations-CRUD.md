# 3. Opérations CRUD

## 3.1 Insertion de données

### insertOne()
Permet d'insérer un seul document dans une collection.
```javascript
db.articles.insertOne({
    titre: "Introduction à MongoDB",
    auteur: "Jean Dupont",
    date_publication: new Date("2024-01-15"),
    categorie: "Base de données",
    contenu: "MongoDB est une base de données NoSQL...",
    tags: ["NoSQL", "MongoDB", "Base de données"]
})
```

Résultat :
```javascript
{
    acknowledged: true,
        insertedId: ObjectId("507f1f77bcf86cd799439011")
}
```
- acknowledged: true → le serveur confirme avoir **reçu et enregistré** l’opération.
- acknowledged: false → tu as demandé une écriture **non confirmée** (cas rare, pour des raisons de performance).
### insertMany()
Permet d'insérer plusieurs documents en une seule opération.
```javascript
db.articles.insertMany([
    {
        titre: "Les requêtes avancées",
        auteur: "Marie Martin",
        date_publication: new Date("2024-01-20"),
        categorie: "Tutoriel",
        tags: ["Requêtes", "MongoDB"]
    },
    {
        titre: "Optimisation des performances",
        auteur: "Jean Dupont",
        date_publication: new Date("2024-01-25"),
        categorie: "Performance",
        tags: ["Optimisation", "Index"]
    }
])
```

### Génération automatique des `_id`

Points importants :
- Chaque document possède un champ _id unique
- Si non fourni, MongoDB génère automatiquement un ObjectId
- Possibilité de fournir son propre _id (doit rester unique)
```javascript
// Avec _id personnalisé
db.produits.insertOne({
    _id: "PROD-001",
    nom: "Ordinateur portable",
    prix: 899.99
})
```

### Gestion des erreurs
Erreur de duplication d'_id :
```javascript
// Génère une erreur si l'_id existe déjà
db.produits.insertOne({
    _id: "PROD-001",
    nom: "Tablette"
})
// Error: E11000 duplicate key error
```

Option ordered avec insertMany :
```javascript
db.produits.insertMany([
    { _id: 1, nom: "Produit 1" },
    { _id: 1, nom: "Produit 2" }, // Erreur
    { _id: 2, nom: "Produit 3" }
], { ordered: false }) // Continue malgré l'erreur
```

---

## 3.2 Lecture de données

### find()
Récupère tous les documents correspondant au filtre.
```javascript
// Tous les documents
db.articles.find()

// Avec filtre
db.articles.find({ auteur: "Jean Dupont" })

// Avec plusieurs critères
db.articles.find({
    auteur: "Jean Dupont",
    categorie: "Base de données"
})
```

### findOne()
Retourne un seul document (le premier trouvé).
```javascript
db.articles.findOne({ titre: "Introduction à MongoDB" })
```

### Projection de champs
Sélectionne uniquement les champs à retourner.
Syntaxe : 1 = inclure, 0 = exclure
```javascript
// Inclure uniquement titre et auteur
db.articles.find(
    { categorie: "Tutoriel" },
    { titre: 1, auteur: 1 }
)

// Résultat :
// { _id: ObjectId("..."), titre: "Les requêtes avancées", auteur: "Marie Martin" }

// Exclure le contenu
db.articles.find(
    { categorie: "Tutoriel" },
    { contenu: 0 }
)

// Exclure _id
db.articles.find(
    {}, // le filtre vide
    { _id: 0, titre: 1, auteur: 1 }
)
```
### pretty()
Améliore la lisibilité de l'affichage (Shell MongoDB).
```javascript
db.articles.find().pretty()
```

---

## 3.3 Mise à jour de données

```javascript
db.utilisateurs.insertOne(
    { email: "jean.dupont@example.com" }
)
```

### updateOne()
Met à jour le premier document correspondant au filtre.
```javascript
db.utilisateurs.updateOne(
    { email: "jean.dupont@example.com" },
    { $set: { ville: "Paris", age: 35 } }
)
```

### updateMany()
Met à jour tous les documents correspondant au filtre.
```javascript
db.produits.updateMany(
    { categorie: "Électronique" },
    { $set: { promotion: true, remise: 10 } }
)
```

### replaceOne()
Remplace entièrement un document (sauf _id).
```javascript
db.utilisateurs.replaceOne(
    { _id: ObjectId("507f1f77bcf86cd799439011") },
    {
        nom: "Dupont",
        prenom: "Jean",
        email: "jean.dupont@example.com",
        ville: "Lyon"
    }
)
```

### Opérateurs de mise à jour
#### $set
Modifie ou ajoute des champs.
```javascript
db.utilisateurs.insertOne(
    { email: "marie@example.com" }
)

db.utilisateurs.updateOne(
    { email: "marie@example.com" },
    { $set: { telephone: "0123456789", actif: true } }
)
```

#### $unset
Supprime des champs.
```javascript
db.utilisateurs.updateOne(
    { email: "marie@example.com" },
    { $unset: { telephone: "" } }
)
```

#### $inc
Incrémente une valeur numérique.
```javascript
// Augmente le stock de 10
db.produits.updateOne(
    { _id: "PROD-001" },
    { $inc: { stock: 10 } }
)

// Décrémente avec une valeur négative
db.produits.updateOne(
    { _id: "PROD-001" },
    { $inc: { stock: -5 } }
)
```

#### $push
Ajoute un élément à un tableau.
```javascript
db.utilisateurs.updateOne(
    { email: "jean@example.com" },
    { $push: { interets: "Photographie" } }
)

// Ajouter plusieurs éléments
db.utilisateurs.updateOne(
    { email: "jean@example.com" },
    { $push: {
            interets: {
                $each: ["Voyage", "Cuisine"]
            }
        }
    }
)
```

#### $pull
Retire un élément d'un tableau.
```javascript
db.utilisateurs.updateOne(
    { email: "jean@example.com" },
    { $pull: { interets: "Photographie" } }
)

// Retirer selon une condition
db.commandes.updateOne(
    { _id: "CMD-001" },
    { $pull: { articles: { quantite: 0 } } }
)
```

### Upsert
Insère un document si aucun ne correspond au filtre.
```javascript
db.produits.updateOne(
    { reference: "PROD-999" },
    {
        $set: {
            nom: "Nouveau produit",
            prix: 49.99
        }
    },
    { upsert: true }
)
```

### Options supplémentaires
```javascript
// Retourner le document modifié
db.utilisateurs.findOneAndUpdate(
    { email: "jean.dupont@example.com" },
    { $set: { ville: "Marseille" } },
    { returnNewDocument: true }
)
```

---

## 3.4 Suppression de données

### deleteOne()
Supprime le premier document correspondant au filtre.
```javascript
db.articles.deleteOne({ _id: ObjectId("507f1f77bcf86cd799439011") })

db.utilisateurs.deleteOne({ email: "marie@example.com" })
```

Résultat :
```javascript
{ acknowledged: true, deletedCount: 1 }
```

### deleteMany()
Supprime tous les documents correspondant au filtre.
```javascript
// Supprimer tous les articles d'une catégorie
db.articles.deleteMany({ categorie: "Brouillon" })

// Supprimer tous les documents de la collection
db.articles.deleteMany({})
```

### Précautions et bonnes pratiques

Points importants :
- Toujours tester le filtre avec find() avant de supprimer
- La suppression est définitive
- Préférer un système de "soft delete" avec un flag pour les données sensibles
- Vérifier le deletedCount dans le résultat

Exemple de soft delete :
```javascript
// Au lieu de supprimer
db.utilisateurs.updateOne(
    { email: "jean.dupont@example.com" },
    { $set: { supprime: true, date_suppression: new Date() } }
)

// Requêtes ultérieures
db.utilisateurs.find({ supprime: { $ne: true } })
```

### Suppression d'une collection complète
```javascript
// Supprime la collection et ses index
db.articles.drop()
```